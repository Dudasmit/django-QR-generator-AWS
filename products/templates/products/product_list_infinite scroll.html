{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link rel="stylesheet" href="{% static 'products/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-bar label {
            margin-right: 5px;
        }
        .filter-bar input, .filter-bar select {
            padding: 5px;
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
        }
        .product-table th, .product-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .product-table th {
            background-color: #f5f5f5;
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>

<h1>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h1>

<form id="filter-form" method="get" class="filter-bar">
    {% for field in filter.form %}
        <div>
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
        </div>
    {% endfor %}
    <button type="submit">üîç –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
</form>

<div id="product-table">
    {% include "products/includes/product_rows.html" %}
</div>

<div id="loading" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>

<script>
    let currentPage = 2;
    let isLoading = false;
    let hasNext = true;

    const loadingDiv = document.getElementById("loading");
    const productTable = document.getElementById("product-table");
    const filterForm = document.getElementById("filter-form");

    function serializeForm(form) {
        const formData = new FormData(form);
        return new URLSearchParams(formData).toString();
    }

    async function loadNextPage() {
        if (isLoading || !hasNext) return;

        isLoading = true;
        loadingDiv.style.display = 'block';

        const queryParams = serializeForm(filterForm) + `&page=${currentPage}`;
        const url = window.location.pathname + "?" + queryParams;

        try {
            const response = await fetch(url, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (response.ok) {
                const data = await response.json();
                const wrapper = document.createElement('div');
                wrapper.innerHTML = data.html;
                productTable.appendChild(wrapper);
                hasNext = data.has_next;
                if (hasNext) currentPage++;
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        } finally {
            isLoading = false;
            loadingDiv.style.display = 'none';
        }
    }

    window.addEventListener("scroll", () => {
        const scrollY = window.scrollY;
        const viewportHeight = window.innerHeight;
        const fullHeight = document.documentElement.scrollHeight;

        if (scrollY + viewportHeight + 150 >= fullHeight) {
            loadNextPage();
        }
    });

    if (filterForm) {
        filterForm.addEventListener("submit", function (e) {
            e.preventDefault();
            window.location.href = "?" + serializeForm(filterForm);
        });
    }
</script>

</body>
</html>
